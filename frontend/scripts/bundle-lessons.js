/**
 * Pre-build script: bundles all lesson.md and exercise.md files
 * into src/lessonData.ts so they work on Vercel (where parent dirs aren't available).
 */
import { readFileSync, writeFileSync, readdirSync, existsSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const modulesDir = join(__dirname, "..", "..", "modules");
const outFile = join(__dirname, "..", "src", "lessonData.ts");

// Skip if modules dir doesn't exist (e.g. Vercel CLI deploy — uses committed lessonData.ts)
if (!existsSync(modulesDir)) {
  console.log("modules/ directory not found — skipping lesson bundling (using existing lessonData.ts)");
  process.exit(0);
}

const folders = readdirSync(modulesDir).filter((f) => /^\d{2}-/.test(f)).sort();

const lessons = {};
const exercises = {};

for (const folder of folders) {
  const lessonPath = join(modulesDir, folder, "lesson.md");
  const exercisePath = join(modulesDir, folder, "exercise.md");

  if (existsSync(lessonPath)) {
    lessons[folder] = readFileSync(lessonPath, "utf-8");
  }
  if (existsSync(exercisePath)) {
    exercises[folder] = readFileSync(exercisePath, "utf-8");
  }
}

const escapeTemplate = (s) => s.replace(/\\/g, "\\\\").replace(/`/g, "\\`").replace(/\$/g, "\\$");

let output = "// AUTO-GENERATED by scripts/bundle-lessons.js — do not edit manually\n\n";
output += "export const lessons: Record<string, string> = {\n";
for (const [folder, content] of Object.entries(lessons)) {
  output += `  "${folder}": \`${escapeTemplate(content)}\`,\n`;
}
output += "};\n\n";
output += "export const exercises: Record<string, string> = {\n";
for (const [folder, content] of Object.entries(exercises)) {
  output += `  "${folder}": \`${escapeTemplate(content)}\`,\n`;
}
output += "};\n";

writeFileSync(outFile, output, "utf-8");
console.log(`Bundled ${Object.keys(lessons).length} lessons and ${Object.keys(exercises).length} exercises into src/lessonData.ts`);
